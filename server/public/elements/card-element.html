<link rel="import" href="/bower/polymer/polymer.html">

<dom-module id="card-element">
  <style>
    :host {
      position: relative;
      display: inline-block;
      box-sizing: border-box;
    }
    img {
      width: 100%;
    }
    #card {
      transform: translate3d(0,0,0) rotateY(0deg);
      transform-origin: 50% 64%;
      transition: all 500ms;
      -webkit-transform-style: preserve-3d;
      position: absolute;
      left: 0; top: 0;
    }
    content {
      position: absolute;
      left: 0; top: 0;
    }
    .face {
      position: absolute;
      left: 0; top: 0;
      transition: all 500ms;
      z-index: 0;
      width: 100%;
      height: 100%;
      border: 1px solid black;
      border-radius: 7%;
      backface-visibility: hidden;
      box-sizing: border-box;
      overflow: hidden;
    }
    .back.face {
      transform: rotateY(-180deg);
    }
  </style>
  <template>
    <div id="card">
      <div id="front" class="front face">
        <img src="/assets/images/card-front.png">
        <content class="content"/>
      </div>
      <div id="back" class="back face">
        <img src="/assets/images/card-back.png">
      </div>
    </div>
  </template>

<script>
  Polymer({
    is: "card-element",
    behaviors: [],
    listeners: {
      'transitionend': 'transitionEnded',
    },
    properties: {
      aspect: {
        value: 1.390625,
      },
      name: {
        type: String,
        value: null,
      },
      description: {
        type: String,
        value: "This is a temporary description",
      },
      faceup: {
        type: Boolean,
        value: true,
        observer: "transformChanged",
        reflectToAttribute: true,
        // notify: true
      },
      facedown: {
        type: Boolean,
        value: false,
        observer: "facedownChanged"
      },
      rotated: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
        observer: "transformChanged"
      },
      height: {
        type: Number,
        observer: "heightChanged",
        value: 0
      },
      zoomed: {
        type: Boolean,
        value: false,
        reflectToAttribute: true,
        observer: "zoomedChanged",
        // notify: true
      },
      frontface_image: {
        type: String,
        value: "/assets/images/card-front-background.png"
      },
      backface_image: {
        type: String,
        value: "/assets/images/card-back.png"
      }
    },

    // Life cycle

    ready: function() {
      this.transitions = [];
      this.resetSize();
      this.transformChanged();
      this.zoomedChanged();
    },
    attached: function() {
      this.resetSize();
      this.transformChanged();
      this.zoomedChanged();
    },

    // card transformations

    flip: function() {
      this.faceup = !this.faceup;
    },
    zoom: function() {
      this.zoomed = !this.zoomed;
    },
    rotate: function() {
      this.rotated = !this.rotated;
    },
    lock: function() {
      return new Promise(function(result, reject) {
        var bounds = this.getBoundingClientRect();
        var el = this.$.card;
        el.style.left = -bounds.left;
        el.style.top = -bounds.top;
        // TODO: is this going to cause a transition? should this delay?
        result();
      }.bind(this));

    },
    raise: function() {

    },
    move: function(stack) {
      this.transitions.push(function(approve, reject) {
        this.detach();
        stack.appendChild(this);

        // TODO: verify this won't cause a transition
        approve();
      });
      this._transist();
      return this;
    },
    _transist: function(func) {
      if (func) {
        this._transitions.push(func);
      }
      if (this._transition) {
        // already going
        return;
      }
      this._transition = new Promise(this._transitions.pop());
      this._transition.then(function() {
        this._transition = null;
        this._transist();
      }.bind(this));
    },

    // other

    /** sets the card to absolute coordinates */git 
    raise: function(height) {
      return new Promise(function(result, reject) {
        this.height = height;
        // TODO: return on transition end
        result();
      }.bind(this));
    },
    resetSize: function() {
      var parentHeight = 100;
      if (this.parentNode) {
        parentHeight = this.parentNode.style.height.replace(/[^0-9]/, '');
        parentHeight = parseFloat(parentHeight) || 100;
      }

      var el = this;
      el.style.height = parentHeight;
      el.style.width = parentHeight;

      el = this.$.card;
      el.style.height = parentHeight;
      el.style.width = parentHeight / this.aspect;
    },
    transitionEnded: function() {
      console.log("transition ended");
    },
    zoomedChanged: function() {
      var bounds = this.getBoundingClientRect();
      if (this.rotated || (!this.faceup)) {
        this.transformChanged();
      }
      var el = this.$.card;
      if (this.zoomed) {
        el.style.left = -bounds.left;
        el.style.top = -bounds.top;
        el.style.marginLeft = "5vw";
        el.style.width = "90vw";
        el.style.height = "calc(90vw * " + this.aspect + ")";
        this.style.zIndex = 90;
      } else {
        el.style.left = 0;
        el.style.top = 0;
        el.style.marginLeft = "0vw";
        // el.style.width = "100%";
        // el.style.height = "100%";
        this.resetSize();
        // TODO: use transitionend
        setTimeout(function() {
          this.style.zIndex = this.height;
        }.bind(this), 500);
      }
    },
    facedownChanged: function() {
      this.faceup = !this.facedown;
    },
    transformChanged: function() {
      var el = this.$.card;
      if (this.faceup || this.zoomed) {
        el.style.transform = "rotateY(0deg)";
      } else {
        el.style.transform = "rotateY(-180deg)";
      }
      if (!this.rotated || this.zoomed) {
        el.style.transform += " rotate(0deg)";
      } else {
        if (this.faceup) {
          el.style.transform += " rotate(90deg)";
        } else {
          el.style.transform += " rotate(-90deg)";
        }
      }
    },
    heightChanged: function() {
      var card = this;
      card.style.top = -this.height;
      card.style.zIndex = this.height;
    }
  });
</script>
</dom-module>
